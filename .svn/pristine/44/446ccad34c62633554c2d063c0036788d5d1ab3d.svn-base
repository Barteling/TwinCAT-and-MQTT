<?xml version="1.0" encoding="utf-8"?>
<TcPlcObject Version="1.1.0.1" ProductVersion="3.1.4022.12">
  <POU Name="MAIN" Id="{0d666fc9-df30-40f9-b555-d1129e0440e1}" SpecialFunc="None">
    <Declaration><![CDATA[PROGRAM MAIN
VAR
	fbMqttClient: FB_IotMqttClient; // MQTT client.       
    TopicToPublish   : STRING(255) := 'Temperatures'; // Mqtt topic on which we will broadcast the acual temperatures
    MessageToPublish : STRING(255); //String to send.
    fbSendMessageIntervalTimer : TON := (PT:=T#1S);	//Interval timer for broadcasting.

	ai_RoomTemperature AT %I* : INT; //Actual room temperature, linked to thermocouple	   
END_VAR

    ]]></Declaration>
    <Implementation>
      <ST><![CDATA[IF _TaskInfo[GETCURTASKINDEXEX()].FirstCycle THEN    
    fbMqttClient.sHostName      := '192.168.178.14';
    fbMqttClient.nHostPort      := 1883;
    fbMqttClient.sTopicPrefix   := '';     
	fbMqttClient.sClientId 		:= 'Publishing PLC';
END_IF

fbMqttClient.Execute(TRUE);

IF fbMqttClient.bConnected THEN
    fbSendMessageIntervalTimer(IN:=TRUE);
    IF fbSendMessageIntervalTimer.Q THEN
        fbSendMessageIntervalTimer(IN:=FALSE);        
        MessageToPublish := CONCAT('Room temperature: ',REAL_TO_STRING(ai_RoomTemperature / 10.0));
		
        fbMqttClient.Publish(sTopic:= TopicToPublish, 
        	pPayload:= ADR(MessageToPublish), 
			nPayloadSize:= LEN2(ADR(MessageToPublish))+1, 
            eQoS:= TcIotMqttQos.AtMostOnceDelivery, 
			bRetain:= FALSE,
			bQueue:= FALSE);
    END_IF
END_IF
 ]]></ST>
    </Implementation>
    <LineIds Name="MAIN">
      <LineId Id="295" Count="0" />
      <LineId Id="297" Count="2" />
      <LineId Id="343" Count="0" />
      <LineId Id="300" Count="7" />
      <LineId Id="329" Count="0" />
      <LineId Id="319" Count="0" />
      <LineId Id="309" Count="1" />
      <LineId Id="316" Count="0" />
      <LineId Id="311" Count="0" />
      <LineId Id="317" Count="0" />
      <LineId Id="332" Count="0" />
      <LineId Id="312" Count="1" />
      <LineId Id="66" Count="0" />
    </LineIds>
  </POU>
</TcPlcObject>